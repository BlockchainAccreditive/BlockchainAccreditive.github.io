<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blockchain Accreditive</title>
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px;background: linear-gradient(43deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%);
    height: 97vh;}
 .container {
     max-width: 700px;
     margin: auto;
}
 button {
    padding: 10px 20px;
    margin-top: 10px;
    cursor: pointer;
    background: yellow;
    border: 0;
    border-radius: 5px;
    font-weight: 900;
    color: blue;
}
 input {
  -webkit-appearance: none;
    padding:10px;
    margin: 10px 0;
    width:100%;
    font-family:monospace;
    width:94%;
    border-radius:5px;
    border: none;
    outline: none;
    color: green;
    font-weight: 900;
}
input#expiryRange {
    border: 0;
    width: 92%;
}
 input:focus {
    outline: none !important;
    border:5px solid yellow;
    position: relative;
    left:-3px;
    border-radius:5px;
}
 .output, .wallet-info {
     margin-top: 20px;
     padding: 10px;font-weight: 900;
     background: #f9f9f9;
     border: 1px solid #ddd;
}::-webkit-scrollbar {width: 0px;}

* {border: 1px solid #f00; }
​
  </style>

  <style>
.form-container {
	/*width: 100vw;*/
	/*height: 100vh;
	background-color: #7b2cbf;*/
	display: flex;
   	justify-content: center;
	align-items: center;
       /* left: -20px;
    position: relative*/
}
.upload-files-container {
	
/*	width: 420px; */
	/*padding: 30px 60px;*/
	border-radius: 40px;
	display: flex;
   	align-items: center;
   	justify-content: center;
	flex-direction: column;
	/*
	box-shadow: rgba(0, 0, 0, 0.24) 0px 10px 20px, rgba(0, 0, 0, 0.28) 0px 6px 6px;
    */
	}
.drag-file-area {
	border: 2px dashed #7b2cbf;
  background-color: #fff;
	border-radius: 40px;
	margin: 10px 0 15px;
     /*padding: 30px 50px;*/
	    width: 90%;
	text-align: center;
}
.drag-file-area .upload-icon {
	font-size: 50px;
}
.drag-file-area h3 {
	font-size: 26px;
	margin: 15px 0;
}
.drag-file-area label {
	font-size: 19px;
}
.drag-file-area label .browse-files-text {
	color: #7b2cbf;
	font-weight: bolder;
	cursor: pointer;
}
.browse-files span {
	position: relative;
	top: -25px;
}
.default-file-input {
	opacity: 0;
}
.cannot-upload-message {
	background-color: #ffc6c4;
	font-size: 17px;
	display: flex;
	align-items: center;
	margin: 5px 0;
	padding: 5px 10px 5px 30px;
	border-radius: 5px;
	color: #BB0000;
	display: none;
}
@keyframes fadeIn {
  0% {opacity: 0;}
  100% {opacity: 1;}
}
.cannot-upload-message span, .upload-button-icon {
	padding-right: 10px;
}
.cannot-upload-message span:last-child {
	padding-left: 20px;
	cursor: pointer;
}
.file-block {
	color: #f7fff7;
	background-color: #7b2cbf;
        transition: all 1s;
	/*width: 390px;*/
	position: relative;
	display: none;
	flex-direction: row;
	justify-content: space-between;
	align-items: center;
      /*margin: 10px 0 15px;*/
	padding: 10px 20px;
	border-radius: 25px;
	cursor: pointer;
  padding-bottom: 60px !important;
}
.file-info {
	display: flex;
	align-items: center;
	font-size: 15px;
}
.file-icon {
	margin-right: 10px;
}
.file-name, .file-size {
	padding: 0 3px;
}
.remove-file-icon {
	cursor: pointer;
}
.progress-bar {
	display: flex;
	position: absolute;
	bottom: 0;
	left: 4.5%;
	width: 0;
	height: 5px;
	border-radius: 25px;
	background-color: #4BB543;
}
.upload-button {
	background-color: #7b2cbf;
	color: #f7fff7;
	display: flex;
	align-items: center;
	font-size: 18px;
	border: none;
	border-radius: 20px;
	margin: 10px;
	padding: 7.5px 50px;
	cursor: pointer;
}
	</style>


</head>
<body style="font-family: monospace;">
  <div class="container">
    <h1 style="color: white;">Blockchain Accreditive</h1>


    <!-- Document Upload Section -->
    <form class="form-container" enctype='multipart/form-data' style="text-align: center;
    display: inline-block;">
      <div class="upload-files-container">
        <div class="drag-file-area">
          <span class="material-icons-outlined upload-icon"> file_upload </span>
          <h3 class="dynamic-message">DOCUMENTS </h3>
          <label class="label"> or <span class="browse-files"> <input type="file" class="default-file-input"/ multiple> <span class="browse-files-text">BROWSE</span> <span>FROM DEVCIE</span> </span> </label>
        </div>
        <span class="cannot-upload-message"> <span class="material-icons-outlined">error</span> Please select a file first <span class="material-icons-outlined cancel-alert-button">cancel</span> </span>
        <div class="file-block">
          <div class="file-info" contenteditable="true"> <span class="material-icons-outlined file-icon">description</span> <span class="file-name"> </span>
            
            | <span class="file-size">  </span> </div>
          <span class="material-icons remove-file-icon">delete</span>
          <div style="position:absolute;margin-top:94px;width:90.35%;"> 
            <input type="text" placeholder="comment"> </div>
          <div class="progress-bar"> </div>
        </div>
        <button type="button" class="upload-button"> Upload </button>
      </div>
    </form>

    <!-- MetaMask Wallet Section -->
    <h2 style="color: white;">Wallet Info</h2>
        <!--<button onclick="getWalletInfo()">Показать</button>-->
   <script>window.onload = function() {getWalletInfo()}</script>
    <div id="walletInfo" class="wallet-info" style="
text-transform:uppercase;
width:94%;border:5px solid yellow;
position:relative;background-image: url(MetaMask_Fox.svg.png);
background-size: 100px;background-repeat: no-repeat;background-position: 85% 90%;
left:-3px;border-radius:5px;
"></div>

    <!-- Letter of Credit Section -->
    <h2 style="color: white;">Accreditive</h2>
    <h3 style="color: white;">Create</h3>
    <input id="beneficiary" type="text" placeholder="Beneficiary Address (e.g., 0x123...)">
    <input id="amount" type="number" placeholder="Amount (ETH)">
    <label for="expiryRange" style="color: white;">EXPIRY DATE  (DAYS): <span id="expiryValue">30</span></label>
    <input id="expiryRange" type="range" min="1" max="365" value="30" oninput="updateExpiryValue()">
    <button onclick="createLetterOfCredit()" style="text-transform: uppercase;">Create Accreditive</button>

    <h3 style="color: white;">Approve Accreditive</h3>
    <input id="locId" type="text" placeholder="Accreditive ID">
    <button onclick="approveLetterOfCredit()" style="text-transform: uppercase;">Approve Accreditive</button>

    <div id="locOutput" class="output" style="text-transform:uppercase;width:94%;border:5px solid yellow;position:relative;left:-3px;border-radius:5px;"></div>
  </div>

<script>
  let web3;                // Переменная для хранения экземпляра Web3
  let walletAddress;       // Переменная для хранения адреса кошелька MetaMask
  let contract;            // Переменная для хранения экземпляра контракта

  // Указание ABI контракта и адреса контракта (нужно заменить на реальные данные)
  const contractABI = [
    {
      "inputs": [
        { "internalType": "address", "name": "_beneficiary", "type": "address" },  // Адрес получателя
        { "internalType": "uint256", "name": "_amount", "type": "uint256" }         // Сумма аккредитива
      ],
      "name": "createLetterOfCredit",  // Функция для создания аккредитива
      "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
      "stateMutability": "nonpayable",  // Функция не изменяет состояние сети
      "type": "function"
    },
    {
      "inputs": [{ "internalType": "uint256", "name": "_locId", "type": "uint256" }],
      "name": "approveLetterOfCredit",  // Функция для утверждения аккредитива
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];
  const contractAddress = "0xYourContractAddress";  // Адрес развернутого контракта (нужно заменить на настоящий)

  // Инициализация Web3 и MetaMask
  if (window.ethereum) {
    web3 = new Web3(window.ethereum);  // Создаем экземпляр Web3, используя Ethereum провайдер MetaMask
    ethereum.request({ method: 'eth_requestAccounts' });  // Запрашиваем доступ к аккаунтам MetaMask
    contract = new web3.eth.Contract(contractABI, contractAddress);  // Инициализируем контракт с ABI и адресом
  } else {
    alert("MetaMask is not installed. Please install MetaMask to use this app.");
    // Если MetaMask не установлен, выводим предупреждение
  }

  // Функция для получения информации о кошельке MetaMask
  async function getWalletInfo() {
    try {
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });  // Получаем доступ к аккаунтам
      walletAddress = accounts[0];  // Сохраняем первый аккаунт в переменную
      const balanceInWei = await web3.eth.getBalance(walletAddress);  // Получаем баланс в Wei
      const balanceInEther = web3.utils.fromWei(balanceInWei, 'ether');  // Преобразуем в Ether

      const chainId = await web3.eth.getChainId();  // Получаем ID текущей сети
      const networkName = getNetworkName(chainId);  // Определяем имя сети по ее ID

      // Выводим информацию о кошельке на страницу
      document.getElementById('walletInfo').innerHTML = `
        <h3 style="color: blue;">Wallet Address</h3>
        <p style="color:green;" onclick="copyAdress()">${walletAddress}</p>
        <h3 style="color: blue;">Balance</h3>
        <p style="color: green;">${balanceInEther} ETH</p>
        <h3 style="color: blue;">Current Network</h3>
        <p style="color: green;">${networkName} (Chain ID: ${chainId})</p>
      `;
    } catch (error) {
      // В случае ошибки выводим сообщение
      document.getElementById('walletInfo').innerText = `Error: ${error.message}`;
    }
  }

  // Функция для получения имени сети по ее ID
  function getNetworkName(chainId) {
    const networks = {
      1: "Ethereum Mainnet",  // Основная сеть Ethereum
      3: "Ropsten",  // Тестовая сеть Ropsten
      4: "Rinkeby",  // Тестовая сеть Rinkeby
      5: "Goerli",  // Тестовая сеть Goerli
      42: "Kovan",  // Тестовая сеть Kovan
      11155111: "Sepolia",  // Тестовая сеть Sepolia
      1337: "Localhost (Ganache)"  // Локальная сеть для тестирования
    };
    return networks[chainId] || "Unknown Network";  // Возвращаем имя сети по ID или "Unknown Network"
  }

  // Функция для создания аккредитива
  async function createLetterOfCredit() {
    try {
      // Получаем данные с формы
      const beneficiary = document.getElementById('beneficiary').value;  // Получатель аккредитива
      const amount = web3.utils.toWei(document.getElementById('amount').value, 'ether');  // Сумма в Ether
      const expiry = document.getElementById('expiryRange').value;


      // Получаем аккаунты MetaMask
      const accounts = await web3.eth.getAccounts();

      // Отправляем транзакцию на создание аккредитива
      const result = await contract.methods.createLetterOfCredit(beneficiary, amount).send({ from: accounts[0] });

      // Извлекаем ID аккредитива из события контракта
      const locId = result.events.LoCCreated.returnValues.locId;  // Получаем ID из события LoCCreated (нужно настроить контракт для этого)

      // Отображаем результат на странице
      document.getElementById('locOutput').innerText = `LoC Created: ID ${locId}`;
    } catch (error) {
      // В случае ошибки выводим сообщение
      document.getElementById('locOutput').innerText = `Error: ${error.message}`;
    }
  }

  // Функция для утверждения аккредитива
  async function approveLetterOfCredit() {
    try {
      const locId = document.getElementById('locId').value;  // Получаем ID аккредитива
      const accounts = await web3.eth.getAccounts();  // Получаем аккаунты MetaMask

      // Отправляем транзакцию на утверждение аккредитива
      await contract.methods.approveLetterOfCredit(locId).send({ from: accounts[0] });

      // Отображаем результат на странице
      document.getElementById('locOutput').innerText = `LoC Approved: ID ${locId}`;
    } catch (error) {
      // В случае ошибки выводим сообщение
      document.getElementById('locOutput').innerText = `Error: ${error.message}`;
    }
  }

  function updateExpiryValue() {
    const expiryValue = document.getElementById('expiryRange').value;
    document.getElementById('expiryValue').innerText = expiryValue;
  }
</script>


<script>
  var isAdvancedUpload = function() {
    var div = document.createElement('div');
    return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
  }();
  
  let draggableFileArea = document.querySelector(".drag-file-area");
  let browseFileText = document.querySelector(".browse-files");
  let uploadIcon = document.querySelector(".upload-icon");
  let dragDropText = document.querySelector(".dynamic-message");
  let fileInput = document.querySelector(".default-file-input");
  let cannotUploadMessage = document.querySelector(".cannot-upload-message");
  let cancelAlertButton = document.querySelector(".cancel-alert-button");
  let uploadedFile = document.querySelector(".file-block");
  let fileName = document.querySelector(".file-name");
  let fileSize = document.querySelector(".file-size");
  let progressBar = document.querySelector(".progress-bar");
  let removeFileButton = document.querySelector(".remove-file-icon");
  let uploadButton = document.querySelector(".upload-button");
  let fileFlag = 0;
  let filesArray = [];
  const MAX_FILES = 20;
  
  fileInput.addEventListener("click", () => {
    fileInput.value = '';
 // console.log(fileInput.value);
  });
  
  fileInput.addEventListener("change", e => {
    console.log(" > " + fileInput.value)
    uploadIcon.innerHTML = 'check_circle';
    dragDropText.innerHTML = 'File Dropped Successfully!';
    document.querySelector(".label").innerHTML = `<span class="browse-files"> <input type="file" class="default-file-input" style=""/> <span class="browse-files-text" style="top: 0;"> browse file</span></span>`;
    uploadButton.innerHTML = `Upload`;
    fileName.innerHTML = fileInput.files[0].name.split('.')[0].length > 24 ? fileInput.files[0].name.split('.')[0].slice(0, 14) + "..." : fileInput.files[0].name.split('.')[0];
    fileSize.innerHTML = (fileInput.files[0].size/1024).toFixed(1) + " KB";
    uploadedFile.style.cssText = "display: flex;";
    progressBar.style.width = 0;
    fileFlag = 0;
  });
  
  uploadButton.addEventListener("click", () => {
    let isFileUploaded = fileInput.value;
    if(isFileUploaded != '') {
      if (fileFlag == 0) {
          fileFlag = 1;
          var width = 0;
          var id = setInterval(frame, 50);
          function frame() {
              if (width >= 390) {
                clearInterval(id);
            uploadButton.innerHTML = `<span class="material-icons-outlined upload-button-icon"> check_circle </span> Uploaded`;
              } else {
                width += 5;
                progressBar.style.width = width + "px";
              }
          }
        }
    } else {
      cannotUploadMessage.style.cssText = "display: flex; animation: fadeIn linear 1.5s;";
    }
  });
  
  cancelAlertButton.addEventListener("click", () => {
    cannotUploadMessage.style.cssText = "display: none;";
  });
  
  if(isAdvancedUpload) {
    ["drag", "dragstart", "dragend", "dragover", "dragenter", "dragleave", "drop"].forEach( evt => 
      draggableFileArea.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
      })
    );
  
    ["dragover", "dragenter"].forEach( evt => {
      draggableFileArea.addEventListener(evt, e => {
        e.preventDefault();
        e.stopPropagation();
        uploadIcon.innerHTML = 'file_download';
        dragDropText.innerHTML = 'Drop your file here!';
      });
    });
  
    draggableFileArea.addEventListener("drop", e => {
      uploadIcon.innerHTML = 'check_circle';
      dragDropText.innerHTML = 'Documents Dropped Successfully!';
      document.querySelector(".label").innerHTML = `<span class="browse-files"> <input type="file" class="default-file-input" style=""/> <span class="browse-files-text" style="top: -23px; left: -20px;"> browse file</span> </span>`;
      uploadButton.innerHTML = `Upload`;
      
      let files = e.dataTransfer.files;
      fileInput.files = files;
      console.log(files[0].name + " " + files[0].size);
      console.log(document.querySelector(".default-file-input").value);
      fileName.innerHTML = files[0].name;
      fileSize.innerHTML = (files[0].size/1024).toFixed(1) + " KB";
      uploadedFile.style.cssText = "display: flex;";
      progressBar.style.width = 0;
      fileFlag = 0;
    });
  }
  
  removeFileButton.addEventListener("click", () => {
    uploadedFile.style.cssText = "display: none;";
    fileInput.value = '';
    uploadIcon.innerHTML = 'file_upload';
    dragDropText.innerHTML = 'DOCUMENTS';
    document.querySelector(".label").innerHTML = `<span class="browse-files"> <input type="file" class="default-file-input"/> <span class="browse-files-text">browse file</span> <span>from device</span> </span>`;
    uploadButton.innerHTML = `UPLOAD`;
  });
  </script>

</body>
</html>
